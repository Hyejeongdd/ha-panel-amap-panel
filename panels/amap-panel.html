<meta
    name="viewport"
    content="initial-scale=1.0, user-scalable=no, width=device-width"
/>
<dom-module id="ha-panel-amap-panel">
    <template>
        <style type="text/css" class="AMap.Scale">
            .amap-scalecontrol {
                position: absolute;
                z-index: 150;
            }
            .amap-scale-text {
                text-align: center;
                font-size: 10px;
            }
            .amap-scale-line {
                position: relative;
                height: 8px;
            }
            .amap-scale-line div {
                -webkit-box-sizing: content-box !important;
                -moz-box-sizing: content-box !important;
                box-sizing: content-box !important;
            }
            .amap-scale-edgeleft,
            .amap-scale-middle,
            .amap-scale-edgeright {
                position: absolute;
                background-color: #333;
                overflow: hidden;
            }
            .amap-scale-edgeleft,
            .amap-scale-edgeright {
                width: 1px;
                _width: 3px;
                height: 6px;
                _height: 8px;
                border: solid 1px #fff;
            }
            .amap-scale-middle {
                height: 2px;
                _height: 4px;
                left: 2px;
                top: 2px;
                border-top: solid 1px #fff;
                border-bottom: solid 1px #fff;
            }
        </style>
        <style type="text/css">
            .amap-indoor-map .label-canvas {
                position: absolute;
                top: 0;
                left: 0;
            }
            .amap-indoor-map .highlight-image-con * {
                pointer-events: none;
            }
            .amap-indoormap-floorbar-control {
                position: absolute;
                margin: auto 0;
                bottom: 165px;
                right: 12px;
                width: 35px;
                text-align: center;
                line-height: 1.3em;
                overflow: hidden;
                padding: 0 2px;
            }
            .amap-indoormap-floorbar-control .panel-box {
                background-color: rgba(255, 255, 255, 0.9);
                border-radius: 3px;
                border: 1px solid #ccc;
            }
            .amap-indoormap-floorbar-control .select-dock {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                box-sizing: border-box;
                height: 30px;
                border: solid #4196ff;
                border-width: 0 2px;
                border-radius: 2px;
                pointer-events: none;
                background: linear-gradient(
                    to bottom,
                    #f6f8f9 0,
                    #e5ebee 50%,
                    #d7dee3 51%,
                    #f5f7f9 100%
                );
            }
            .amap-indoor-map .transition {
                transition: opacity 0.2s;
            }
            ,
            .amap-indoormap-floorbar-control .transition {
                transition: top 0.2s, margin-top 0.2s;
            }
            .amap-indoormap-floorbar-control .select-dock:after,
            .amap-indoormap-floorbar-control .select-dock:before {
                content: "";
                position: absolute;
                width: 0;
                height: 0;
                left: 0;
                top: 10px;
                border: solid transparent;
                border-width: 4px;
                border-left-color: #4196ff;
            }
            .amap-indoormap-floorbar-control .select-dock:after {
                right: 0;
                left: auto;
                border-left-color: transparent;
                border-right-color: #4196ff;
            }
            .amap-indoormap-floorbar-control.is-mobile {
                width: 37px;
            }
            .amap-indoormap-floorbar-control.is-mobile .floor-btn {
                height: 35px;
                line-height: 35px;
            }
            .amap-indoormap-floorbar-control.is-mobile .select-dock {
                height: 35px;
                top: 36px;
            }
            .amap-indoormap-floorbar-control.is-mobile .select-dock:after,
            .amap-indoormap-floorbar-control.is-mobile .select-dock:before {
                top: 13px;
            }
            .amap-indoormap-floorbar-control.is-mobile .floor-list-box {
                height: 105px;
            }
            .amap-indoormap-floorbar-control .floor-list-item .floor-btn {
                color: #555;
                font-family: "Times New Roman", sans-serif, "Microsoft Yahei";
                font-size: 16px;
            }
            .amap-indoormap-floorbar-control
                .floor-list-item.selected
                .floor-btn {
                color: #000;
            }
            .amap-indoormap-floorbar-control .floor-btn {
                height: 28px;
                line-height: 28px;
                overflow: hidden;
                cursor: pointer;
                position: relative;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            .amap-indoormap-floorbar-control .floor-btn:hover {
                background-color: rgba(221, 221, 221, 0.4);
            }
            .amap-indoormap-floorbar-control .floor-minus,
            .amap-indoormap-floorbar-control .floor-plus {
                position: relative;
                text-indent: -1000em;
            }
            .amap-indoormap-floorbar-control .floor-minus:after,
            .amap-indoormap-floorbar-control .floor-plus:after {
                content: "";
                position: absolute;
                margin: auto;
                top: 9px;
                left: 0;
                right: 0;
                width: 0;
                height: 0;
                border: solid transparent;
                border-width: 10px 8px;
                border-top-color: #777;
            }
            .amap-indoormap-floorbar-control .floor-minus.disabled,
            .amap-indoormap-floorbar-control .floor-plus.disabled {
                opacity: 0.3;
            }
            .amap-indoormap-floorbar-control .floor-plus:after {
                border-bottom-color: #777;
                border-top-color: transparent;
                top: -3px;
            }
            .amap-indoormap-floorbar-control .floor-list-box {
                max-height: 153px;
                position: relative;
                overflow-y: hidden;
            }
            .amap-indoormap-floorbar-control .floor-list {
                margin: 0;
                padding: 0;
                list-style: none;
            }
            .amap-indoormap-floorbar-control .floor-list-item {
                position: relative;
            }
            .amap-indoormap-floorbar-control .floor-btn.disabled,
            .amap-indoormap-floorbar-control .floor-btn.disabled *,
            .amap-indoormap-floorbar-control.with-indrm-loader * {
                -webkit-pointer-events: none !important;
                pointer-events: none !important;
            }
            .amap-indoormap-floorbar-control .with-indrm-loader .floor-nonas {
                opacity: 0.5;
            }
            .amap-indoor-map-moverf-marker {
                color: #555;
                background-color: #fffeef;
                border: 1px solid #7e7e7e;
                padding: 3px 6px;
                font-size: 12px;
                white-space: nowrap;
                display: inline-block;
                position: absolute;
                top: 1em;
                left: 1.2em;
            }
            .amap-indoormap-floorbar-control .amap-indrm-loader {
                -moz-animation: amap-indrm-loader 1250ms infinite linear;
                -webkit-animation: amap-indrm-loader 1250ms infinite linear;
                animation: amap-indrm-loader 1250ms infinite linear;
                border: 2px solid #91a3d8;
                border-right-color: transparent;
                box-sizing: border-box;
                display: inline-block;
                overflow: hidden;
                text-indent: -9999px;
                width: 13px;
                height: 13px;
                border-radius: 7px;
                position: absolute;
                margin: auto;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
            }
            @-moz-keyframes amap-indrm-loader {
                0% {
                    -moz-transform: rotate(0deg);
                    transform: rotate(0deg);
                }
                100% {
                    -moz-transform: rotate(360deg);
                    transform: rotate(360deg);
                }
            }
            @-webkit-keyframes amap-indrm-loader {
                0% {
                    -webkit-transform: rotate(0deg);
                    transform: rotate(0deg);
                }
                100% {
                    -webkit-transform: rotate(360deg);
                    transform: rotate(360deg);
                }
            }
            @keyframes amap-indrm-loader {
                0% {
                    -moz-transform: rotate(0deg);
                    -ms-transform: rotate(0deg);
                    -webkit-transform: rotate(0deg);
                    transform: rotate(0deg);
                }
                100% {
                    -moz-transform: rotate(360deg);
                    -ms-transform: rotate(360deg);
                    -webkit-transform: rotate(360deg);
                    transform: rotate(360deg);
                }
            }
        </style>
        <style type="text/css" class="AMap.ToolBar">
            .amap-toolbar {
                z-index: 150;
            }
            .amap-toolbar {
                position: absolute;
                width: 52px;
                overflow: visible;
            }
            .amap-pancontrol {
                width: 52px;
                height: 52px;
                background: url(https://webapi.amap.com/theme/v1.3/map_view.png)
                    0 -140px;
                position: absolute;
                _background: url(https://webapi.amap.com/theme/v1.3/map_view.gif);
            }
            .amap-pan-left,
            .amap-pan-top,
            .amap-pan-right,
            .amap-pan-bottom {
                position: absolute;
                cursor: pointer;
            }
            .amap-pan-left,
            .amap-pan-right {
                width: 12px;
                height: 18px;
                top: 17px;
            }
            .amap-pan-top,
            .amap-pan-bottom {
                width: 18px;
                height: 12px;
                left: 17px;
            }
            .amap-pan-left {
                left: 8px;
            }
            .amap-pan-right {
                left: 32px;
            }
            .amap-pan-top {
                top: 8px;
            }
            .amap-pan-bottom {
                top: 31px;
            }
            .amap-pan-left:hover,
            .amap-pan-top:hover,
            .amap-pan-right:hover,
            .amap-pan-bottom:hover {
                background: url(https://webapi.amap.com/theme/v1.3/map_view.png);
                _background: url(https://webapi.amap.com/theme/v1.3/map_view.gif);
            }
            .amap-pan-left:hover {
                background-position: -52px -110px;
            }
            .amap-pan-top:hover {
                background-position: -70px -112px;
            }
            .amap-pan-right:hover {
                background-position: -61px -110px;
            }
            .amap-pan-bottom:hover {
                background-position: -84px -110px;
            }
            .amap-pan-left-hover {
                _background: url(https://webapi.amap.com/theme/v1.3/map_view.gif);
                background-position: -52px -110px;
            }
            .amap-pan-top-hover {
                _background: url(https://webapi.amap.com/theme/v1.3/map_view.gif);
                background-position: -70px -112px;
            }
            .amap-pan-right-hover {
                _background: url(https://webapi.amap.com/theme/v1.3/map_view.gif);
                background-position: -61px -110px;
            }
            .amap-pan-bottom-hover {
                _background: url(https://webapi.amap.com/theme/v1.3/map_view.gif);
                background-position: -84px -110px;
            }
            .amap-zoomcontrol {
                width: 24px;
                position: absolute;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                -o-user-select: none;
                user-select: none;
            }
            .amap-zoom-plus,
            .amap-zoom-minus,
            .amap-zoom-cursor,
            .amap-zoom-label-street,
            .amap-zoom-label-city,
            .amap-zoom-label-province,
            .amap-zoom-label-country {
                background: url(https://webapi.amap.com/theme/v1.3/map_view.png);
                _background: url(https://webapi.amap.com/theme/v1.3/map_view.gif);
                cursor: pointer;
            }
            .amap-zoom-ruler,
            .amap-zoom-mask {
                background: url(https://webapi.amap.com/theme/v1.3/toolbar_rbg.png);
                cursor: pointer;
            }
            .amap-zoom-ruler {
                overflow: visible;
            }
            .amap-zoom-plus,
            .amap-zoom-minus {
                width: 24px;
                height: 21px;
            }
            .amap-zoom-plus {
                background-position: 0 -217px;
            }
            .amap-zoom-plus:hover {
                background-position: 0 -194px;
            }
            .amap-zoom-minus {
                background-position: -26px -224px;
            }
            .amap-zoom-minus:hover {
                background-position: -26px -195px;
            }
            .amap-zoom-plus2:hover {
                background-position: -50px -194px;
                cursor: default;
            }
            .amap-zoom-minus2:hover {
                background-position: -50px -223px;
                cursor: default;
            }
            .amap-zoom-ruler {
                width: 12px;
                height: 147px;
                position: relative;
                left: 6px;
                background-position: 0 0;
            }
            .amap-zoom-mask,
            .amap-zoom-cursor,
            .amap-zoom-labels,
            .amap-zoom-label-street,
            .amap-zoom-label-city,
            .amap-zoom-label-province,
            .amap-zoom-label-country {
                position: absolute;
            }
            .amap-zoom-mask {
                width: 12px;
                height: 106px;
                background-position: -14px 0;
            }
            .amap-zoom-cursor {
                width: 24px;
                height: 20px;
                left: -6px;
                top: 106px;
                background-position: -127px -164px;
            }
            .amap-zoom-cursor:hover {
                background-position: -127px -141px;
            }
            .amap-zoom-labels {
                display: none;
            }
            .amap-zoom-label-street,
            .amap-zoom-label-city,
            .amap-zoom-label-province,
            .amap-zoom-label-country {
                width: 39px;
                height: 31px;
                left: 20px;
            }
            .amap-zoom-label-street {
                top: 0;
                background-position: -87px -140px;
            }
            .amap-zoom-label-city {
                top: 54px;
                background-position: -87px -171px;
            }
            .amap-zoom-label-province {
                top: 92px;
                background-position: -87px -203px;
            }
            .amap-zoom-label-country {
                top: 129px;
                background-position: -87px -235px;
            }
            .amap-locate {
                position: absolute;
                width: 18px;
                height: 18px;
                background: url(https://webapi.amap.com/theme/v1.3/map_view.png);
                _background: url(https://webapi.amap.com/theme/v1.3/map_view.gif);
                background-position: -130px -185px;
                cursor: pointer;
            }
            .amap-geo {
                width: 30px;
                height: 30px;
                cursor: pointer;
                bottom: 18px;
                right: 7px;
            }
            .amap-toolbar-geo {
                position: absolute;
            }
            .amap-touch-toolbar .amap-zoomcontrol {
                position: absolute;
                right: 4px;
                bottom: -80px;
                z-index: 500;
                width: 35px;
                background-color: white;
                background-color: rgba(255, 255, 255, 0.9);
                border-radius: 3px;
                border: 1px solid #ccc;
                box-shadow: 1px 1px 10px 0 #ccc;
            }
            .amap-touch-toolbar .amap-zoomcontrol:after {
                position: absolute;
                content: "";
                height: 1px;
                background: #ddd;
                top: 48px;
                width: 60%;
                margin: auto;
                left: 0;
                right: 0;
            }
            .amap-toolbar-geo-secc {
                background-image: url(https://webapi.amap.com/theme/v1.3/markers/b/loc.png) !important;
                background-size: 22px 22px !important;
                background-position-x: 6px !important;
            }
            .amap-touch-toolbar .amap-geo {
                background: #fff
                    url(https://webapi.amap.com/theme/v1.3/markers/b/loc_gray.png)
                    50% 50% no-repeat;
                width: 35px;
                height: 35px;
                border: 1px solid #ccc;
                border-radius: 3px;
                right: 4px;
            }
            .amap-touch-toolbar .amap-locate-loading {
                background-image: url(https://webapi.amap.com/theme/v1.3/loading.gif);
            }
            .amap-zoom-touch-plus {
                margin-bottom: 5px;
            }
            amap-zoom-touch-plus,
            .amap-zoom-touch-minus {
                width: 100%;
                height: 43px;
                background-color: white;
                background-color: rgba(255, 255, 255, 0.5);
            }
            .amap-zoom-touch-plus > div,
            .amap-zoom-touch-minus > div {
                margin: auto;
                font-size: 26px;
                line-height: 43px;
                font-family: verdana;
                text-align: center;
                color: #666;
                height: 100%;
                cursor: pointer;
            }
            .amap-zoom-touch > div {
                opacity: 0.2;
            }
        </style>
        <style type="text/css" class="AMap.style">
            .vml {
                behavior: url(#default#VML);
                display: inline-block;
                position: absolute;
            }
            .amap-custom {
                top: 0;
                left: 0;
                position: absolute;
            }
            .amap-container img {
                max-width: none !important;
                max-height: none !important;
            }
            .amap-container {
                touch-action: none;
                position: relative;
                overflow: hidden;
                background: #fcf9f2
                    url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0AgMAAAC2uDcZAAAADFBMVEX////////////////1pQ5zAAAABHRSTlMAgP/AWuZC2AAAAVhJREFUeAFiYGAQYGDEQjAB2rcDC4BiGIqiU7abdKlO2QkeIClyPsDHweMKtOPHIJ1Op6/w7Y4fdqfT6VpndzqdrnV2p9PpWmd3Oj3qWndSoKp+2J1Op7vr7E6n07XO7nQ6XevsTqfTtc7udPo4/f787E6n0911dqfT6VpndzqdrnV2p9PpWmd3Ot27Ce8m6HS6u85dR6fTtU7r6HS61mkdnU7XOrvT6XTvJuxOp9PddXan0+laZ3c6na51dDpd67SOTqd7N+HdBJ1Od9e56+h0utZpHZ1O1zq70+l0rbM7nU73bsLudDrdXWd3Ol3rtI5Op2ud1tHpdK3TOjqd7t2EdxN0Ot1dZ3c6na51dqfT6VpndzqdrnV2p9Pp3k3Q6XR3nbuOTqdrndbR6XSt0zo6na51Wken072bsDudTnfX2Z1Op2ud3el0utbZnU7XOq2j0+t0uncTD1gO4zoT5doZAAAAAElFTkSuQmCC);
                -ms-touch-action: none;
            }
            .amap-drags,
            .amap-layers {
                width: 100%;
                height: 100%;
                position: absolute;
                overflow: hidden;
            }
            .amap-layers canvas {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            .amap-layer img {
                pointer-events: none;
            }
            .amap-e,
            .amap-maps {
                width: 100%;
                height: 100%;
            }
            .amap-maps,
            .amap-e,
            .amap-layers,
            .amap-tile,
            .amap-tile-container {
                position: absolute;
                left: 0;
                top: 0;
                overflow: hidden;
            }
            .amap-context {
                position: absolute;
                left: 0;
                top: 0;
            }
            .amap-overlays,
            .amap-markers,
            .amap-marker {
                position: absolute;
                left: 0;
                top: 0;
            }
            .amap-layers {
                z-index: 0;
            }
            .amap-overlays {
                z-index: 110;
                cursor: default;
            }
            .amap-markers {
                z-index: 120;
            }
            .amap-controls {
                z-index: 150;
            }
            .amap-copyright {
                position: absolute;
                display: block !important;
                left: 77px;
                height: 16px;
                bottom: 0;
                padding-bottom: 3px;
                font-size: 11px;
                font-family: Arial, sans-serif;
                z-index: 160;
            }
            .amap-logo {
                position: absolute;
                bottom: 1px;
                left: 1px;
                z-index: 160;
                height: 20px;
            }
            .amap-logo img {
                width: 73px !important;
                height: 20px !important;
                border: 0;
                vertical-align: baseline !important;
            }
            .amap-icon {
                position: relative;
                z-index: 1;
            }
            .amap-icon img {
                position: absolute;
                z-index: -1;
            }
            .amap-marker-label {
                position: absolute;
                z-index: 2;
                border: 1px solid blue;
                background-color: white;
                white-space: nowrap;
                cursor: default;
                padding: 3px;
                font-size: 12px;
                line-height: 14px;
            }
            .amap-info {
                position: absolute;
                left: 0;
                z-index: 140;
                width: 320px;
            }
            .amap-menu {
                position: absolute;
                z-index: 140;
                _width: 100px;
            }
            .amap-info-close {
                position: absolute;
                right: 5px;
                _right: 12px;
                +right: 11px;
                top: 5px;
                _top: 2px;
                +top: 2px;
                color: #c3c3c3;
                text-decoration: none;
                font: bold 16px/14px Tahoma, Verdana, sans-serif;
                width: 14px;
                height: 14px;
            }
            .amap-info-outer,
            .amap-menu-outer {
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                background: none repeat scroll 0 0 white;
                border-radius: 2px;
                padding: 1px;
                text-align: left;
            }
            .amap-menu-outer:hover {
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            }
            .amap-info-contentContainer:hover .amap-info-outer {
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            }
            .amap-info-content {
                position: relative;
                background: #fff;
                padding: 10px 18px 10px 10px;
                line-height: 1.4;
                overflow: auto;
            }
            .amap-marker-content {
                position: relative;
            }
            .amap-info {
                _width: 320px;
            }
            .amap-menu {
                _width: 100px;
            }
            .amap-info-sharp-old {
                overflow: hidden;
                position: absolute;
                background-image: url(http://webapi.amap.com/images/arrows.png);
            }
            .bottom-center .amap-info-sharp-old {
                height: 12px;
                margin: 0 auto;
                width: 20px;
                background-position: center 12px;
                top: 100%;
                margin-top: -9px;
                left: 50%;
                margin-left: -10px;
            }
            .bottom-left .amap-info-sharp-old {
                height: 12px;
                width: 13px;
                background-position: -16px -46px;
                top: 100%;
                margin-top: -9px;
            }
            .bottom-right .amap-info-sharp-old {
                height: 12px;
                width: 13px;
                top: -1px;
                background-position: -56px -46px;
                left: 100%;
                margin-left: -13px;
                top: 100%;
                margin-top: -9px;
            }
            .middle-left .amap-info-sharp-old {
                height: 20px;
                width: 12px;
                background-position: left;
                top: 50%;
                margin-top: -10px;
                margin-left: -11px;
            }
            .center .amap-info-sharp-old {
                display: none;
            }
            .middle-right .amap-info-sharp-old {
                height: 20px;
                margin-right: 0;
                width: 12px;
                background-position: right;
                left: 100%;
                margin-left: -9px;
                top: 50%;
                margin-top: -10px;
            }
            .top-center .amap-info-sharp-old {
                height: 12px;
                margin: 0 auto;
                width: 20px;
                background-position: top;
                top: 0;
                margin-top: -3px;
                left: 50%;
                margin-left: -10px;
            }
            .top-left .amap-info-sharp-old {
                height: 12px;
                width: 13px;
                background-position: -16px -3px;
                top: 0;
                margin-top: -3px;
            }
            .top-right .amap-info-sharp-old {
                height: 12px;
                width: 13px;
                background-position: -56px -3px;
                left: 100%;
                margin-left: -13px;
                top: 0;
                margin-top: -3px;
            }
            .amap-info-sharp {
                position: absolute;
            }
            .bottom-center .amap-info-sharp {
                bottom: 0;
                left: 50%;
                margin-left: -8px;
                border-left: 8px solid transparent;
                border-right: 8px solid transparent;
                border-top: 8px solid #fff;
            }
            .bottom-center .amap-info-sharp:after {
                position: absolute;
                content: "";
                margin-left: -8px;
                margin-top: -7px;
                border-left: 8px solid transparent;
                border-right: 8px solid transparent;
                border-top: 8px solid rgba(0, 0, 0, 0.3);
                filter: blur(2px);
                z-index: -1;
            }
            .amap-info-contentContainer:hover.bottom-center
                .amap-info-sharp:after {
                border-top: 8px solid rgba(0, 0, 0, 0.5);
            }
            .bottom-left .amap-info-sharp {
                border-color: transparent #fff;
                border-width: 0 0 10px 10px;
                border-style: solid;
            }
            .bottom-left .amap-info-sharp:after {
                position: absolute;
                content: "";
                margin-left: -10px;
                border-color: transparent rgba(0, 0, 0, 0.3);
                border-width: 0 0 10px 10px;
                border-style: solid;
                filter: blur(1px);
                z-index: -1;
            }
            .amap-info-contentContainer:hover.bottom-left
                .amap-info-sharp:after {
                border-color: transparent rgba(0, 0, 0, 0.5);
            }
            .bottom-left .amap-info-content {
                border-radius: 2px 2px 2px 0;
            }
            .bottom-right .amap-info-sharp {
                right: 0;
                border-top: 10px solid #fff;
                border-left: 10px solid transparent;
            }
            .bottom-right .amap-info-sharp:after {
                position: absolute;
                margin-top: -9px;
                margin-left: -10px;
                content: "";
                border-top: 10px solid rgba(0, 0, 0, 0.3);
                border-left: 10px solid transparent;
                filter: blur(1px);
                z-index: -1;
            }
            .amap-info-contentContainer:hover.bottom-right
                .amap-info-sharp:after {
                border-top: 10px solid rgba(0, 0, 0, 0.5);
            }
            .bottom-right .amap-info-content {
                border-radius: 2px 2px 0 2px;
            }
            .top-center .amap-info-sharp {
                top: 0;
                left: 50%;
                margin-left: -8px;
                border-left: 8px solid transparent;
                border-right: 8px solid transparent;
                border-bottom: 8px solid #fff;
            }
            .top-center .amap-info-sharp:after {
                position: absolute;
                content: "";
                margin-top: 0;
                margin-left: -8px;
                border-left: 8px solid transparent;
                border-right: 8px solid transparent;
                border-bottom: 8px solid rgba(0, 0, 0, 0.3);
                filter: blur(1px);
                z-index: -1;
            }
            .top-left .amap-info-sharp {
                left: 0;
                top: 0;
                border-bottom: 10px solid #fff;
                border-right: 10px solid transparent;
            }
            .top-left .amap-info-sharp:after {
                position: absolute;
                content: "";
                margin-top: 0;
                margin-left: 0;
                border-bottom: 10px solid rgba(0, 0, 0, 0.3);
                border-right: 10px solid transparent;
                filter: blur(1px);
                z-index: -1;
            }
            .top-right .amap-info-sharp {
                right: 0;
                top: 0;
                border-bottom: 10px solid #fff;
                border-left: 10px solid transparent;
            }
            .top-right .amap-info-sharp:after {
                position: absolute;
                content: "";
                margin-top: 0;
                margin-left: -10px;
                border-bottom: 10px solid rgba(0, 0, 0, 0.3);
                border-left: 10px solid transparent;
                filter: blur(1px);
                z-index: -1;
            }
            .middle-right .amap-info-sharp {
                right: 0;
                top: 50%;
                margin-top: -8px;
                border-top: 8px solid transparent;
                border-left: 8px solid #fff;
                border-bottom: 8px solid transparent;
            }
            .middle-right .amap-info-sharp:after {
                position: absolute;
                content: "";
                margin-top: -8px;
                margin-left: -8px;
                border-top: 8px solid transparent;
                border-left: 8px solid rgba(0, 0, 0, 0.3);
                border-bottom: 8px solid transparent;
                filter: blur(1px);
                z-index: -1;
            }
            .amap-info-contentContainer:hover.middle-right
                .amap-info-sharp:after {
                border-left: 8px solid rgba(0, 0, 0, 0.5);
            }
            .middle-left .amap-info-sharp {
                left: 0;
                top: 50%;
                margin-top: -8px;
                border-top: 8px solid transparent;
                border-right: 8px solid #fff;
                border-bottom: 8px solid transparent;
            }
            .middle-left .amap-info-sharp:after {
                position: absolute;
                content: "";
                margin-top: -8px;
                margin-left: 0;
                border-top: 8px solid transparent;
                border-right: 8px solid rgba(0, 0, 0, 0.3);
                border-bottom: 8px solid transparent;
                filter: blur(1px);
                z-index: -1;
            }
            .amap-info-contentContainer:hover.middle-left
                .amap-info-sharp:after {
                border-right: 8px solid rgba(0, 0, 0, 0.5);
            }
            .amap-info-contentContainer.top-left,
            .amap-info-contentContainer.top-center,
            .amap-info-contentContainer.top-right {
                padding-top: 8px;
            }
            .amap-info-contentContainer.bottom-left,
            .amap-info-contentContainer.bottom-center,
            .amap-info-contentContainer.bottom-right {
                padding-bottom: 8px;
            }
            .amap-info-contentContainer.middle-right {
                padding-right: 8px;
            }
            .amap-info-contentContainer.middle-left {
                padding-left: 8px;
            }
            .amap-menu-outer {
                margin: 0;
                padding: 0;
                list-style-type: none;
            }
            ul.amap-menu-outer li {
                cursor: pointer;
                height: 35px;
                line-height: 35px;
                word-break: break-all;
                padding: 0 10px;
                font-size: 12px;
                white-space: nowrap;
            }
            ul.amap-menu-outer li a {
                text-decoration: none;
                font-size: 13px;
                margin: 0 5px;
                color: #000;
                padding: 5px 5px;
            }
            ul.amap-menu-outer li:hover {
                background-color: #f3f3ee;
            }
            .amap-overlay-text-container {
                display: block;
                width: auto;
                word-break: keep-all;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                background: #fff;
                padding: 2px 3px;
                border: 1px solid #ccc;
                border-radius: 3px;
            }
            .amap-overlay-text-container.amap-overlay-text-empty {
                display: none;
            }
            .amap-info-content-ie8 {
                border: 1px solid #9c9c9c;
            }
        </style>
        <style include="ha-style">
            #AmapMap {
                position: relative;
                width: 100%;
                height: calc(100% - 64px);
                overflow: hidden;
            }
            .input-card {
                display: flex;
                flex-direction: column;
                word-wrap: break-word;
                background-color: rgba(255, 255, 255, 0.75);
                background-clip: border-box;
                border-radius: 5px;
                border-width: 0;
                box-shadow: 0 2px 6px 0 rgba(114, 124, 245, 0.5);
                position: fixed;
                flex: 1 1 auto;
                padding: 10px;
                width: auto;
                top: 74px;
                right: 10px;
                bottom: auto;
            }
            .input-item {
                position: relative;
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                width: 100%;
                height: 24px;
            }
            .device-marker {
                position: relative;
                display: block;
                margin: 0 auto;
                width: 38px;
                text-align: center;
                height: 38px;
                line-height: 38px;
                font-size: 14px;
                border-radius: 50%;
                border: 1px solid
                    var(--ha-marker-color, var(--default-primary-color));
                color: rgb(76, 76, 76);
                background-color: white;
            }
            iron-image {
                position: relative;
                display: block;
                margin: 0 auto;
                width: 38px;
                text-align: center;
                height: 38px;
                border: 1px solid
                    var(--ha-marker-color, var(--default-primary-color));
                border-radius: 50%;
            }
        </style>

        <app-toolbar>
            <ha-menu-button
                hass="[[hass]]"
                narrow="[[narrow]]"
            ></ha-menu-button>
            <div main-title>[[panel.title]]</div>
        </app-toolbar>

        <div id="AmapMap"></div>
        <div class="input-card">
            <div class="input-item">
                <label>
                    <input type="checkbox" on-click="toggleTrafffic" />
                    实时路况
                </label>
            </div>
        </div>
    </template>
</dom-module>

<script>
    //定义一些常量
    var x_PI = (3.14159265358979324 * 3000.0) / 180.0;
    var PI = 3.1415926535897932384626;
    var a = 6378245.0;
    var ee = 0.00669342162296594323;

    /**
     * 百度坐标系 (BD-09) 与 火星坐标系 (GCJ-02)的转换
     * 即 百度 转 谷歌、高德
     * @param bd_lon
     * @param bd_lat
     * @returns {*[]}
     */
    function bd09togcj02(bd_lon, bd_lat) {
        var x_pi = (3.14159265358979324 * 3000.0) / 180.0;
        var x = bd_lon - 0.0065;
        var y = bd_lat - 0.006;
        var z = Math.sqrt(x * x + y * y) - 0.00002 * Math.sin(y * x_pi);
        var theta = Math.atan2(y, x) - 0.000003 * Math.cos(x * x_pi);
        var gg_lng = z * Math.cos(theta);
        var gg_lat = z * Math.sin(theta);
        return [gg_lng, gg_lat];
    }

    /**
     * 火星坐标系 (GCJ-02) 与百度坐标系 (BD-09) 的转换
     * 即谷歌、高德 转 百度
     * @param lng
     * @param lat
     * @returns {*[]}
     */
    function gcj02tobd09(lng, lat) {
        var z =
            Math.sqrt(lng * lng + lat * lat) + 0.00002 * Math.sin(lat * x_PI);
        var theta = Math.atan2(lat, lng) + 0.000003 * Math.cos(lng * x_PI);
        var bd_lng = z * Math.cos(theta) + 0.0065;
        var bd_lat = z * Math.sin(theta) + 0.006;
        return [bd_lng, bd_lat];
    }

    /**
     * WGS84转GCj02
     * @param lng
     * @param lat
     * @returns {*[]}
     */
    function wgs84togcj02(lng, lat) {
        if (out_of_china(lng, lat)) {
            return [lng, lat];
        } else {
            var dlat = transformlat(lng - 105.0, lat - 35.0);
            var dlng = transformlng(lng - 105.0, lat - 35.0);
            var radlat = (lat / 180.0) * PI;
            var magic = Math.sin(radlat);
            magic = 1 - ee * magic * magic;
            var sqrtmagic = Math.sqrt(magic);
            dlat =
                (dlat * 180.0) / (((a * (1 - ee)) / (magic * sqrtmagic)) * PI);
            dlng = (dlng * 180.0) / ((a / sqrtmagic) * Math.cos(radlat) * PI);
            var mglat = lat + dlat;
            var mglng = lng + dlng;
            return [mglng, mglat];
        }
    }

    /**
     * GCJ02 转换为 WGS84
     * @param lng
     * @param lat
     * @returns {*[]}
     */
    function gcj02towgs84(lng, lat) {
        if (out_of_china(lng, lat)) {
            return [lng, lat];
        } else {
            var dlat = transformlat(lng - 105.0, lat - 35.0);
            var dlng = transformlng(lng - 105.0, lat - 35.0);
            var radlat = (lat / 180.0) * PI;
            var magic = Math.sin(radlat);
            magic = 1 - ee * magic * magic;
            var sqrtmagic = Math.sqrt(magic);
            dlat =
                (dlat * 180.0) / (((a * (1 - ee)) / (magic * sqrtmagic)) * PI);
            dlng = (dlng * 180.0) / ((a / sqrtmagic) * Math.cos(radlat) * PI);
            mglat = lat + dlat;
            mglng = lng + dlng;
            return [lng * 2 - mglng, lat * 2 - mglat];
        }
    }

    function transformlat(lng, lat) {
        var ret =
            -100.0 +
            2.0 * lng +
            3.0 * lat +
            0.2 * lat * lat +
            0.1 * lng * lat +
            0.2 * Math.sqrt(Math.abs(lng));
        ret +=
            ((20.0 * Math.sin(6.0 * lng * PI) +
                20.0 * Math.sin(2.0 * lng * PI)) *
                2.0) /
            3.0;
        ret +=
            ((20.0 * Math.sin(lat * PI) + 40.0 * Math.sin((lat / 3.0) * PI)) *
                2.0) /
            3.0;
        ret +=
            ((160.0 * Math.sin((lat / 12.0) * PI) +
                320 * Math.sin((lat * PI) / 30.0)) *
                2.0) /
            3.0;
        return ret;
    }

    function transformlng(lng, lat) {
        var ret =
            300.0 +
            lng +
            2.0 * lat +
            0.1 * lng * lng +
            0.1 * lng * lat +
            0.1 * Math.sqrt(Math.abs(lng));
        ret +=
            ((20.0 * Math.sin(6.0 * lng * PI) +
                20.0 * Math.sin(2.0 * lng * PI)) *
                2.0) /
            3.0;
        ret +=
            ((20.0 * Math.sin(lng * PI) + 40.0 * Math.sin((lng / 3.0) * PI)) *
                2.0) /
            3.0;
        ret +=
            ((150.0 * Math.sin((lng / 12.0) * PI) +
                300.0 * Math.sin((lng / 30.0) * PI)) *
                2.0) /
            3.0;
        return ret;
    }

    /**
     * 判断是否在国内，不在国内则不做偏移
     * @param lng
     * @param lat
     * @returns {boolean}
     */
    function out_of_china(lng, lat) {
        return (
            lng < 72.004 ||
            lng > 137.8347 ||
            lat < 0.8293 ||
            lat > 55.8271 ||
            false
        );
    }

    class HaPanelAmapPanel extends Polymer.Element {
        static get is() {
            return "ha-panel-amap-panel";
        }
        static get properties() {
            return {
                hass: {
                    type: Object,
                    observer: "debouncedHassChanged"
                },
                narrow: {
                    type: Boolean,
                    value: false
                },
                showMenu: {
                    type: Boolean,
                    value: true
                },
                panel: {
                    type: Object
                }
            };
        }

        constructor() {
            super();
            this.amapMap = null;
            this.amapOverlays = [];
            this.debouncedHassChanged = this.debounce(
                this.hassChanged.bind(this),
                500
            );
        }

        ready() {
            super.ready();
            console.log("ready");
        }

        connectedCallback() {
            super.connectedCallback();
            console.log("connectedCallback");
            this.loadScript(
                `https://webapi.amap.com/maps?v=1.4.15&key=${this.panel.config.key}&callback=amapInitCallback&plugin=AMap.Scale,AMap.ToolBar`
            ).then(() => {
                this.initAmapMap();
                this.drawZones(this.hass);
                this.drawDevices(this.hass);
                this.fitMap();
            });
        }

        disconnectedCallback() {
            super.disconnectedCallback();
            console.log("disconnectedCallback");
            this.amapMap && this.amapMap.destroy();
        }

        hassChanged(newHass, oldHass) {
            console.log("hassChanged");
            this.drawDevices(newHass);
        }

        initAmapMap() {
            const amapMapId = this.shadowRoot.querySelector("#AmapMap");
            const lnglat = wgs84togcj02(120.919494, 32.003772);
            const amapMapOption = {
                resizeEnable: true,
                center: lnglat,
                zoom: 13,
                defaultCursor: "pointer"
            };
            const toolBar = new AMap.ToolBar({
                liteStyle: true
            });
            const scale = new AMap.Scale();
            this.amapMap = new AMap.Map(amapMapId, amapMapOption);
            this.amapMap.addControl(toolBar);
            this.amapMap.addControl(scale);
            this.amapMap.on("complete", () => {
                console.log("amap complete");
                this.amapMapTrafficLayer = new AMap.TileLayer.Traffic({
                    autoRefresh: true
                });
                this.amapMapTrafficLayer.hide();
                this.amapMapTrafficLayer.setMap(this.amapMap);
            });
        }

        clearMap() {
            this.amapMap && this.amapMap.clearMap();
        }

        fitMap() {
            this.amapMap && this.amapMap.setFitView();
        }

        toggleTrafffic(e) {
            if (e.target.checked) {
                this.amapMapTrafficLayer.show();
            } else {
                this.amapMapTrafficLayer.hide();
            }
        }

        drawZones(hass) {
            if (!this.amapMap) return;
            let keys = Object.keys(hass.states).filter(
                state => state.indexOf("zone") === 0
            );
            for (let key of keys) {
                const { attributes } = hass.states[key];
                if (
                    "longitude" in attributes &&
                    "latitude" in attributes &&
                    !attributes.passive
                ) {
                    const {
                        longitude,
                        latitude,
                        friendly_name,
                        icon,
                        radius
                    } = attributes;
                    const lnglat = wgs84togcj02(longitude, latitude);
                    // 添加图标
                    const marker = new AMap.Marker({
                        position: lnglat,
                        offset: new AMap.Pixel(-12, -12),
                        title: friendly_name,
                        extData: key,
                        content: `<ha-icon icon=${icon}></ha-icon>`
                    });
                    this.amapMap.add(marker);
                    // 添加圆形区域
                    const circle = new AMap.Circle({
                        center: lnglat,
                        radius: radius,
                        extData: key,
                        strokeColor: "#3366FF",
                        strokeOpacity: 0.3,
                        strokeWeight: 3,
                        fillColor: "#FFA500",
                        fillOpacity: 0.35
                    });
                    this.amapMap.add(circle);
                }
            }
        }

        drawDevices(hass) {
            if (!this.amapMap) return;
            let keys = Object.keys(hass.states).filter(state => {
                const { attributes } = hass.states[state];
                return (
                    state.indexOf("device_tracker") === 0 &&
                    attributes.source_type === "gps" &&
                    "longitude" in attributes &&
                    "latitude" in attributes &&
                    hass.states[state].state != "home"
                );
            });
            // 清除 device_tracker
            const markers = this.amapMap.getAllOverlays("marker");
            for (let marker of markers) {
                const extData = marker.getExtData();
                if (extData.indexOf("device_tracker") === 0) {
                    this.amapMap.remove(marker);
                }
            }
            // 绘制 device_tracker
            for (let key of keys) {
                const { attributes, state } = hass.states[key];
                const {
                    longitude,
                    latitude,
                    friendly_name,
                    entity_picture
                } = attributes;
                const display_name =
                    friendly_name
                        .split(" ")
                        .map(function(part) {
                            return part.substr(0, 1);
                        })
                        .join("") || "";
                const content = entity_picture
                    ? `<iron-image sizing="cover" class="fit" src="${entity_picture}" ></iron-image>`
                    : `<div class="device-marker"> ${display_name}</div>`;
                const lnglat = wgs84togcj02(longitude, latitude);
                const marker = new AMap.Marker({
                    position: lnglat,
                    offset: new AMap.Pixel(-20, -20),
                    extData: key,
                    title: friendly_name,
                    content: content
                });
                marker.on("click", () => {
                    this.fire("hass-more-info", { entityId: key });
                });
                this.amapMap.add(marker);
            }
        }

        loadScript(src) {
            return new Promise((resolve, reject) => {
                const id = btoa(src);
                let ele = document.getElementById(id);
                if (ele) {
                    console.log("Amap init from cache");
                    return resolve();
                }
                window.amapInitCallback = () => {
                    console.log("Amap init from callback");
                    resolve();
                };
                let script = document.createElement("script");
                script.id = id;
                script.type = "text/javascript";
                script.charset = "utf-8";
                script.onerror = reject;
                script.src = src;
                document.head.appendChild(script);
            });
        }

        debounce(func, wait, immediate) {
            let timeout;
            return function(...args) {
                const context = this;
                const later = () => {
                    timeout = null;
                    if (!immediate) func.apply(context, args);
                };
                const callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                if (callNow) func.apply(context, args);
            };
        }

        fire(type, data) {
            const event = new Event(type, {
                bubbles: true,
                cancelable: false,
                composed: true
            });
            event.detail = data;
            this.dispatchEvent(event);
        }
    }

    customElements.define(HaPanelAmapPanel.is, HaPanelAmapPanel);
</script>
